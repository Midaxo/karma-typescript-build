{"version":3,"file":"source-reader.spec.js","sourceRoot":"","sources":["../../../src/bundler/resolve/source-reader.spec.ts"],"names":[],"mappings":"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","sourcesContent":["import * as log4js from \"log4js\";\r\nimport * as mock from \"mock-require\";\r\nimport * as os from \"os\";\r\nimport * as test from \"tape\";\r\n\r\nlet readFileCallback = [undefined, new Buffer(\"\")];\r\n\r\nmock(\"fs\", {\r\n    readFile: (filename: string, callback: (error: Error, buffer: Buffer) => void) => {\r\n        filename = filename;\r\n        return callback(undefined, readFileCallback[1]);\r\n    }\r\n});\r\n\r\nimport { ConfigOptions } from \"karma\";\r\n\r\nimport { KarmaTypescriptConfig } from \"../../api/configuration\";\r\nimport { Configuration } from \"../../shared/configuration\";\r\nimport { Project } from \"../../shared/project\";\r\nimport { BundleItem } from \"../bundle-item\";\r\nimport {Â Transformer } from \"../transformer\";\r\nimport { SourceReader } from \"./source-reader\";\r\n\r\nconst configuration = new Configuration({});\r\nconst project = new Project(configuration, log4js.getLogger(\"project\"));\r\nconst transformer = new Transformer(configuration, log4js.getLogger(\"transformer\"), project);\r\nconst sourceReader = new SourceReader(configuration, log4js.getLogger(\"sourceReader\"), transformer);\r\n\r\nconst karmaTypescriptConfig: KarmaTypescriptConfig = {\r\n    bundlerOptions: {\r\n        ignore: [\"ignored\"],\r\n        noParse: [\"noparse\"]\r\n    }\r\n};\r\n\r\nconst karma: ConfigOptions = {};\r\n(karma as any).karmaTypescriptConfig = karmaTypescriptConfig;\r\n\r\nconfiguration.initialize(karma);\r\n\r\ntest(\"source-reader should return an empty object literal for ignored modules\", (t) => {\r\n\r\n    t.plan(1);\r\n\r\n    const bundleItem = new BundleItem(\"ignored\", \"ignored.js\");\r\n\r\n    sourceReader.read(bundleItem, () => {\r\n        t.equal(bundleItem.source, \"module.exports={};\");\r\n    });\r\n});\r\n\r\ntest(\"source-reader should read source for module\", (t) => {\r\n\r\n    t.plan(1);\r\n\r\n    readFileCallback = [undefined, new Buffer(\"var x;\")];\r\n    const bundleItem = new BundleItem(\"dummy\", \"dummy.js\");\r\n\r\n    sourceReader.read(bundleItem, () => {\r\n        t.equal(bundleItem.source, \"var x;\");\r\n    });\r\n});\r\n\r\ntest(\"source-reader should create an AST\", (t) => {\r\n\r\n    t.plan(1);\r\n\r\n    const bundleItem = new BundleItem(\"dummy\", \"dummy.js\");\r\n\r\n    sourceReader.read(bundleItem, () => {\r\n        t.notEqual(bundleItem.ast, undefined);\r\n    });\r\n});\r\n\r\ntest(\"source-reader should create an empty dummy AST for non-script files (css, JSON...)\", (t) => {\r\n\r\n    t.plan(1);\r\n\r\n    const bundleItem = new BundleItem(\"style\", \"style.css\");\r\n\r\n    sourceReader.read(bundleItem, () => {\r\n        t.equal(bundleItem.ast, undefined);\r\n    });\r\n});\r\n\r\ntest(\"source-reader should create an empty dummy AST for modules specified in the bundler option 'noParse'\", (t) => {\r\n\r\n    t.plan(1);\r\n\r\n    const bundleItem = new BundleItem(\"noparse\", \"noparse.js\");\r\n\r\n    sourceReader.read(bundleItem, () => {\r\n        t.equal(bundleItem.ast, undefined);\r\n    });\r\n});\r\n\r\ntest(\"source-reader should prepend JSON source with 'module.exports ='\", (t) => {\r\n\r\n    t.plan(1);\r\n\r\n    readFileCallback = [undefined, new Buffer(JSON.stringify([1, 2, 3, \"a\", \"b\", \"c\"]))];\r\n    const bundleItem = new BundleItem(\"json\", \"json.json\");\r\n\r\n    sourceReader.read(bundleItem, () => {\r\n        t.equal(bundleItem.source, os.EOL + \"module.exports = [1,2,3,\\\"a\\\",\\\"b\\\",\\\"c\\\"];\");\r\n    });\r\n});\r\n\r\ntest(\"source-reader should prepend stylesheet source (original CSS) with 'module.exports ='\", (t) => {\r\n\r\n    t.plan(1);\r\n\r\n    readFileCallback = [undefined, new Buffer(\".color { color: red; }\")];\r\n    const bundleItem = new BundleItem(\"style\", \"style.css\");\r\n\r\n    sourceReader.read(bundleItem, () => {\r\n        t.equal(bundleItem.source, os.EOL + \"module.exports = \\\".color { color: red; }\\\";\");\r\n    });\r\n});\r\n\r\ntest(\"source-reader should prepend transformed stylesheet source (now JSON) with 'module.exports ='\", (t) => {\r\n\r\n    t.plan(1);\r\n\r\n    readFileCallback = [undefined, new Buffer(JSON.stringify({ color: \"_color_xkpkl_5\" }))];\r\n    const bundleItem = new BundleItem(\"transformed\", \"transformed.css\");\r\n\r\n    sourceReader.read(bundleItem, () => {\r\n        t.equal(bundleItem.source, os.EOL + \"module.exports = {\\\"color\\\":\\\"_color_xkpkl_5\\\"};\");\r\n    });\r\n});\r\n\r\ntest(\"source-reader should not prepend redundant 'module.exports ='\", (t) => {\r\n\r\n    t.plan(1);\r\n\r\n    readFileCallback = [undefined, new Buffer(\"module.exports = '';\")];\r\n    const bundleItem = new BundleItem(\"redundant\", \"redundant.css\");\r\n\r\n    sourceReader.read(bundleItem, () => {\r\n        t.equal(bundleItem.source, \"module.exports = '';\");\r\n    });\r\n});\r\n\r\ntest(\"source-reader should prepend 'module.exports =' to valid javascript with non-script extension, css\", (t) => {\r\n\r\n    t.plan(1);\r\n\r\n    readFileCallback = [undefined, new Buffer(\"{ color: '_color_xkpkl_5'; }\")];\r\n    const bundleItem = new BundleItem(\"valid-js\", \"valid-js.css\");\r\n\r\n    sourceReader.read(bundleItem, () => {\r\n        t.equal(bundleItem.source, os.EOL + \"module.exports = \\\"{ color: \\'_color_xkpkl_5\\'; }\\\";\");\r\n    });\r\n});\r\n\r\ntest(\"source-reader should prepend 'module.exports =' to valid javascript with non-script extension, txt\", (t) => {\r\n\r\n    t.plan(1);\r\n\r\n    readFileCallback = [undefined, new Buffer(\"(function() {return {foo: 'baz',bork: true}})();\")];\r\n    const bundleItem = new BundleItem(\"valid-js\", \"valid-js.txt\");\r\n\r\n    sourceReader.read(bundleItem, () => {\r\n        t.equal(bundleItem.source, os.EOL + \"module.exports = \\\"(function() {return {foo: \\'baz\\',bork: true}})();\\\";\");\r\n    });\r\n});\r\n"]}